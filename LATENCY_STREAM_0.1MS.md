# Latency Test: Stream Mode (0.1ms interval)

**Дата:** 2025-12-05 09:47
**Маркет:** btc-updown-15m-1765014300
**Режим:** Stream spam с интервалом 0.1ms

## Конфигурация

```
SPAM_INTERVAL_MS: 0.1
DELAY_BEFORE_SPAM_MS: 19000
TEST_PRICE: 0.45
```

## Результаты

### Phase 2: Pre-signing
```
Signing took: 580ms
```

### Phase 4: Spam (0.1ms interval)
```
#100: 2s elapsed, 100 in-flight
#200: 3.9s elapsed, 200 in-flight
#300: 5.3s elapsed, 300 in-flight
#288: 620ms - SUCCESS!
```

### Успешный ордер
```json
{
  "orderID": "0xf625d9e6e4a44ceb73e7c537087c527b20c1d1231ddd78f1cd29c61c0a9153ff",
  "status": "live",
  "success": true
}
```

## Статистика

| Метрика | Значение |
|---------|----------|
| Попыток до успеха | 288 |
| Время до успеха | ~5.5s |
| Latency успешного запроса | 620ms |
| In-flight запросов | 327 |
| Скорость запросов | ~55 req/s |

## Сравнение с 0ms interval

| Метрика | 0ms | 0.1ms |
|---------|-----|-------|
| Попыток до успеха | 282 | 288 |
| Latency успеха | 383ms | 620ms |
| In-flight | 309 | 327 |
| Скорость | ~60 req/s | ~55 req/s |

## Анализ API Responses

### Хронология событий (по timestamp)

```
09:47:47.834Z - "orderbook does not exist" (372ms)
09:47:47.900Z - "orderbook does not exist" (382ms)
09:47:48.012Z - "Duplicated" (389ms)          ← РАНЬШЕ успеха!
09:47:48.013Z - "Duplicated" (437ms)          ← РАНЬШЕ успеха!
09:47:48.056Z - "Duplicated" (363ms)          ← РАНЬШЕ успеха!
...
09:47:48.170Z - SUCCESS (620ms)               ← Успешный ордер
09:47:48.176Z - "Duplicated" (394ms)          ← После успеха
```

## Парадокс: Duplicated ДО успешного ордера

### Наблюдение
Ошибки "Duplicated" появились в `09:47:48.012Z`, а успешный ордер только в `09:47:48.170Z` — **на 158ms позже**.

### Объяснение

```
Timeline (client-side sending):
────────────────────────────────────────────────────►
t=0     t=100   t=200   t=288   t=300   ...

Request #288 ─────────────────────────────────► (620ms latency)
                                              │
Request #300 ──────────────────► (389ms)      │
                                 │            │
                                 ▼            ▼
                           "Duplicated"    SUCCESS
                           (раньше!)       (позже!)
```

**Причина:**
1. Запросы отправляются последовательно с интервалом 0.1ms
2. Запрос #288 был отправлен РАНЬШЕ запроса #300
3. Но запрос #288 имел latency **620ms** (дольше)
4. Запрос #300 имел latency **389ms** (быстрее)
5. На СЕРВЕРЕ запрос #288 был обработан ПЕРВЫМ и создал ордер
6. Когда ответ запроса #300 вернулся на клиент (быстрее) — ордер уже существовал на сервере
7. Поэтому мы ВИДИМ "Duplicated" раньше, хотя на сервере ордер уже был создан

### Диаграмма

```
Client                          Server
  │                               │
  │──── Req #288 ────────────────►│
  │                               │ (processing...)
  │──── Req #300 ────────────────►│
  │                               │ #288 creates order
  │                               │ #300 sees duplicate
  │◄─── Resp #300 (Duplicated) ───│  ← приходит РАНЬШЕ
  │                               │
  │◄─── Resp #288 (SUCCESS) ──────│  ← приходит ПОЗЖЕ
  │                               │
```

## Выводы

1. **Network jitter** - разброс latency 346-620ms (почти 2x разница)
2. **Non-FIFO responses** - ответы приходят не в порядке отправки
3. **Server-side race condition** - первый обработанный запрос выигрывает
4. **Timestamp парадокс** - клиентский timestamp ответа ≠ время обработки на сервере
5. **0.1ms vs 0ms** - незначительная разница (~5 req/s), но latency успеха выше (620ms vs 383ms) — возможно случайность

## Рекомендации

1. Не полагаться на порядок ответов для определения "победителя"
2. Высокий in-flight (300+) увеличивает шансы на успех
3. Jitter ~300ms — нормально для HTTP через Cloudflare
