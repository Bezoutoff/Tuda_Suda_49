# CLAUDE.md - ะะพะบัะผะตะฝัะฐัะธั ะฟัะพะตะบัะฐ Tuda Suda 49

## ะะฑะทะพั ะฟัะพะตะบัะฐ

**Tuda Suda 49** โ ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะฑะพั ะดะปั ัะพัะณะพะฒะปะธ ะฝะฐ Polymarket. ะะพั ะพััะปะตะถะธะฒะฐะตั ะฟะพัะฒะปะตะฝะธะต ะฝะพะฒัั BTC updown 15-ะผะธะฝััะฝัั ะผะฐัะบะตัะพะฒ ะธ ะผะณะฝะพะฒะตะฝะฝะพ ัะฐะทะผะตัะฐะตั ะพัะดะตัะฐ ะฝะฐ ะฟะพะบัะฟะบั ะฟะพ 49 ัะตะฝัะพะฒ ะฝะฐ ะพะฑะฐ ะธััะพะดะฐ (YES ะธ NO).

### ะะฐะทะฒะฐะฝะธะต
"ะขัะดะฐ-ะกัะดะฐ 49" โ ะพััะฐะถะฐะตั ัััะฐัะตะณะธั: ััะฐะฒะธะผ ะธ ััะดะฐ (YES), ะธ ััะดะฐ (NO) ะฟะพ 49 ัะตะฝัะพะฒ.

### ะกััะฐัะตะณะธั
BTC updown ะผะฐัะบะตัั โ ััะพ ะบัะฐัะบะพััะพัะฝัะต (15 ะผะธะฝัั) ะฑะธะฝะฐัะฝัะต ะพะฟัะธะพะฝั ะฝะฐ ะดะฒะธะถะตะฝะธะต ัะตะฝั Bitcoin. ะกััะฐัะตะณะธั ะทะฐะบะปััะฐะตััั ะฒ ัะพะผ, ััะพะฑั ะฑััั ะฟะตัะฒัะผ ะฒ ะพัะตัะตะดะธ ะฝะฐ ะพะฑะพะธั ะธััะพะดะฐั ะฟะพ ะฒัะณะพะดะฝะพะน ัะตะฝะต 49ยข. ะัะปะธ ะพัะดะตั ะธัะฟะพะปะฝะธััั ะฟะพ 49ยข, ะฐ ัะตะฐะปัะฝะฐั ะฒะตัะพััะฝะพััั ~50%, ัะพ ะตััั ะฝะตะฑะพะปััะพะต ะฟัะตะธะผััะตััะฒะพ.

## ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Tuda Suda 49 Bot                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ  โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ                โ
โ  โ WebSocket       โ    โ Trading         โ                โ
โ  โ Client (RTDS)   โโโโโถโ Service         โ                โ
โ  โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ                โ
โ          โ                      โ                          โ
โ          โ                      โ                          โ
โ          โผ                      โผ                          โ
โ  โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ                โ
โ  โ Market Filter   โ    โ CLOB Client     โ                โ
โ  โ (btc-updown-15m)โ    โ (Order API)     โ                โ
โ  โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ                โ
โ                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะพะผะฟะพะฝะตะฝัั

1. **WebSocket Client** (`@polymarket/real-time-data-client`)
   - ะะพะดะบะปััะฐะตััั ะบ Polymarket RTDS (Real-Time Data Service)
   - ะะพะดะฟะธััะฒะฐะตััั ะฝะฐ topic `clob_market`, type `market_created`
   - ะะพะปััะฐะตั ัะฒะตะดะพะผะปะตะฝะธั ะพ ัะพะทะดะฐะฝะธะธ ะฝะพะฒัั ะผะฐัะบะตัะพะฒ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ

2. **Market Filter**
   - ะคะธะปััััะตั ะฒัะพะดััะธะต ะผะฐัะบะตัั ะฟะพ ะฟะฐััะตัะฝั `btc-updown-15m`
   - ะะทะฒะปะตะบะฐะตั timestamp ะฝะฐัะฐะปะฐ ัะพัะณะพะฒ ะธะท slug (ะฝะฐะฟัะธะผะตั: `btc-updown-15m-1764054900`)
   - ะัะตะดะพัะฒัะฐัะฐะตั ะดัะฑะปะธัะพะฒะฐะฝะธะต ะพะฑัะฐะฑะพัะบะธ

3. **Trading Service** (`@polymarket/clob-client`)
   - ะกะพะทะดะฐัั ะธ ะพัะฟัะฐะฒะปัะตั ะปะธะผะธัะฝัะต ะพัะดะตัะฐ ะฝะฐ ะฑะธัะถั
   - ะะพะดะดะตัะถะธะฒะฐะตั GTD (Good-Til-Date) ะพัะดะตัะฐ ั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ะพัะผะตะฝะพะน
   - ะัะฟะพะปัะทัะตั POLY_PROXY signature type ะดะปั ะฟะพะดะฟะธัะธ

## ะคะฐะนะปะพะฒะฐั ััััะบัััะฐ

```
Tuda_Suda_49/
โโโ src/
โ   โโโ bot.ts              # Entry point, ะพัะฝะพะฒะฝะฐั ะปะพะณะธะบะฐ ะฑะพัะฐ
โ   โโโ config.ts           # ะะพะฝัะธะณััะฐัะธั ะฑะพัะฐ ะธ trading
โ   โโโ trading-service.ts  # ะกะตัะฒะธั ัะพะทะดะฐะฝะธั ะพัะดะตัะพะฒ (ัะฟัะพััะฝะฝัะน)
โ   โโโ types.ts            # TypeScript ัะธะฟั
โโโ package.json            # ะะฐะฒะธัะธะผะพััะธ ะธ ัะบัะธะฟัั
โโโ tsconfig.json           # ะะพะฝัะธะณััะฐัะธั TypeScript
โโโ .env                    # ะกะตะบัะตัั (ะะ ะฒ git!)
โโโ .env.example            # ะัะธะผะตั ะบะพะฝัะธะณััะฐัะธะธ
โโโ .gitignore
โโโ README.md               # ะะฝััััะบัะธั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
โโโ CLAUDE.md               # ะญัะพั ัะฐะนะป (ะดะพะบัะผะตะฝัะฐัะธั ะดะปั Claude)
```

## ะะปััะตะฒัะต ัะฐะนะปั

### src/bot.ts
ะัะฝะพะฒะฝะพะน ัะฐะนะป ะฑะพัะฐ. ะกะพะดะตัะถะธั:
- `main()` โ ะธะฝะธัะธะฐะปะธะทะฐัะธั ะธ ะทะฐะฟััะบ
- `handleMarketCreated()` โ ะพะฑัะฐะฑะพัะบะฐ ะฝะพะฒะพะณะพ ะผะฐัะบะตัะฐ
- `placeAutoOrders()` โ ัะฐะทะผะตัะตะฝะธะต ะพัะดะตัะพะฒ YES ะธ NO
- `fetchTokenIdsFromGamma()` โ fallback ะดะปั ะฟะพะปััะตะฝะธั token IDs

### src/config.ts
ะะพะฝัะธะณััะฐัะธั:
- `BOT_CONFIG` โ ะฟะฐัะฐะผะตััั ะฑะพัะฐ (ะฟะฐััะตัะฝ ะผะฐัะบะตัะฐ, ัะตะฝะฐ, ัะฐะทะผะตั)
- `tradingConfig` โ ะฝะฐัััะพะนะบะธ trading service ะธะท .env
- ะัะฟะพะผะพะณะฐัะตะปัะฝัะต ััะฝะบัะธะธ: `getOrderSize()`, `extractStartTimestamp()`, `isBtcUpdownMarket()`

### src/trading-service.ts
ะฃะฟัะพััะฝะฝะฐั ะฒะตััะธั trading service ะธะท live-trade-PM:
- `createLimitOrder()` โ ัะพะทะดะฐะฝะธะต ะปะธะผะธัะฝะพะณะพ ะพัะดะตัะฐ
- `cancelOrder()` โ ะพัะผะตะฝะฐ ะพัะดะตัะฐ
- ะะพะดะดะตัะถะบะฐ GTC ะธ GTD ะพัะดะตัะพะฒ

### src/types.ts
TypeScript ัะธะฟั:
- `TradingConfig` โ ะบะพะฝัะธะณััะฐัะธั trading service
- `CreateOrderRequest` โ ะฟะฐัะฐะผะตััั ัะพะทะดะฐะฝะธั ะพัะดะตัะฐ
- `Order` โ ััััะบัััะฐ ะพัะดะตัะฐ
- `OrderUpdate` โ ะพะฑะฝะพะฒะปะตะฝะธะต ััะฐัััะฐ

## ะะพะฝัะธะณััะฐัะธั (.env)

```env
# ะัะธะฒะฐัะฝัะน ะบะปัั ะบะพัะตะปัะบะฐ (64 ัะธะผะฒะพะปะฐ ะะะ 0x)
PK=your_private_key_here

# API credentials ะดะปั Polymarket CLOB
CLOB_API_KEY=your_api_key
CLOB_SECRET=your_secret
CLOB_PASS_PHRASE=your_passphrase

# ะะดัะตั funder (ะดะปั POLY_PROXY, ะพะฟัะธะพะฝะฐะปัะฝะพ)
FUNDER=0x...

# ะะฐะทะผะตั ะพัะดะตัะฐ ะฒ USDC
BOT_ORDER_SIZE=10
```

## ะะพะณะธะบะฐ ัะฐะฑะพัั

### 1. ะะฐะฟััะบ
```
npm start
```
- ะะฐะณััะถะฐะตั .env
- ะะฝะธัะธะฐะปะธะทะธััะตั TradingService
- ะะพะดะบะปััะฐะตััั ะบ Polymarket RTDS
- ะะพะดะฟะธััะฒะฐะตััั ะฝะฐ `market_created`

### 2. ะะพะปััะตะฝะธะต ะฝะพะฒะพะณะพ ะผะฐัะบะตัะฐ
ะะพะณะดะฐ Polymarket ัะพะทะดะฐัั ะฝะพะฒัะน ะผะฐัะบะตั, RTDS ะพัะฟัะฐะฒะปัะตั ัะพะพะฑัะตะฝะธะต:
```json
{
  "type": "market_created",
  "slug": "btc-updown-15m-1764054900",
  "tokens": [
    { "token_id": "123...", "outcome": "Up" },
    { "token_id": "456...", "outcome": "Down" }
  ]
}
```

### 3. ะคะธะปัััะฐัะธั
ะะพั ะฟัะพะฒะตััะตั:
- ะกะพะดะตัะถะธั ะปะธ slug ะฟะฐััะตัะฝ `btc-updown-15m`
- ะะต ะพะฑัะฐะฑะฐััะฒะฐะปัั ะปะธ ััะพั ะผะฐัะบะตั ัะฐะฝะตะต

### 4. ะะทะฒะปะตัะตะฝะธะต ะดะฐะฝะฝัั
- Timestamp ะฝะฐัะฐะปะฐ: `1764054900` ะธะท slug
- Token IDs ะดะปั YES ะธ NO ะธะท ัะพะพะฑัะตะฝะธั ะธะปะธ Gamma API

### 5. ะะฐะทะผะตัะตะฝะธะต ะพัะดะตัะพะฒ
ะะฒะฐ GTD ะพัะดะตัะฐ:
- **YES** @ 0.49 (49 ัะตะฝัะพะฒ)
- **NO** @ 0.49 (49 ัะตะฝัะพะฒ)

GTD expiration = timestamp ะฝะฐัะฐะปะฐ ัะพัะณะพะฒ - 60 ัะตะบัะฝะด (ะฑััะตั)

## API ะธ ะทะฐะฒะธัะธะผะพััะธ

### Polymarket APIs
- **RTDS WebSocket**: `wss://...` โ real-time ัะพะฑััะธั
- **CLOB REST API**: `https://clob.polymarket.com` โ ัะพะทะดะฐะฝะธะต ะพัะดะตัะพะฒ
- **Gamma API**: `https://gamma-api.polymarket.com` โ ะธะฝัะพัะผะฐัะธั ะพ ะผะฐัะบะตัะฐั

### npm ะทะฐะฒะธัะธะผะพััะธ
```json
{
  "@polymarket/clob-client": "^4.22.8",
  "@polymarket/real-time-data-client": "^1.4.0",
  "dotenv": "^17.2.3",
  "ethers": "^5.8.0"
}
```

## ะกะฒัะทั ั live-trade-PM

ะญัะพั ะฟัะพะตะบั ะฑัะป ะฒัะดะตะปะตะฝ ะธะท `live-trade-PM` (ัะพัะณะพะฒัะน ัะตัะผะธะฝะฐะป). ะะปััะตะฒัะต ะพัะปะธัะธั:

| ะัะฟะตะบั | live-trade-PM | Tuda_Suda_49 |
|--------|---------------|--------------|
| ะะฐะทะฝะฐัะตะฝะธะต | ะััะฝะฐั ัะพัะณะพะฒะปั ั UI | ะะฒัะพะผะฐัะธัะตัะบะธะน ะฑะพั |
| UI | Electron + HTML | ะะตั (ัะพะปัะบะพ ะบะพะฝัะพะปั) |
| ะะฐััะตัั | Bwin, Pinnacle, Polymarket | ะขะพะปัะบะพ Polymarket |
| Trading Service | ะะพะปะฝะฐั ะฒะตััะธั | ะฃะฟัะพััะฝะฝะฐั ะฒะตััะธั |
| ะะฐะทะผะตั | ~50+ ัะฐะนะปะพะฒ | 4 ัะฐะนะปะฐ ะฒ src/ |

## ะะพะผะฐะฝะดั

```bash
# ะะฐะฟััะบ ะฑะพัะฐ
npm start

# ะะฐะฟััะบ ะฒ dev ัะตะถะธะผะต (ั ะฟะตัะตะทะฐะฟััะบะพะผ ะฟัะธ ะธะทะผะตะฝะตะฝะธัั)
npm run dev

# ะะพะผะฟะธะปััะธั TypeScript
npm run build
```

## ะะพะทะผะพะถะฝัะต ัะปัััะตะฝะธั

1. **ะะพะฝะธัะพัะธะฝะณ ะธัะฟะพะปะฝะตะฝะธั** โ ะพััะปะตะถะธะฒะฐะฝะธะต fills ัะตัะตะท RTDS `clob_user` topic
2. **ะะธะฝะฐะผะธัะตัะบะฐั ัะตะฝะฐ** โ ะฐะฝะฐะปะธะท order book ะฟะตัะตะด ัะฐะทะผะตัะตะฝะธะตะผ
3. **ะะฝะพะถะตััะฒะตะฝะฝัะต ะฟะฐััะตัะฝั** โ ะฟะพะดะดะตัะถะบะฐ ะดััะณะธั updown ะผะฐัะบะตัะพะฒ (ETH, SOL)
4. **Telegram ัะฒะตะดะพะผะปะตะฝะธั** โ ะพะฟะพะฒะตัะตะฝะธั ะพ ะฝะพะฒัั ะผะฐัะบะตัะฐั ะธ ะธัะฟะพะปะฝะตะฝะธะธ
5. **ะะพะณะธัะพะฒะฐะฝะธะต ะฒ ัะฐะนะป** โ ัะพััะฐะฝะตะฝะธะต ะธััะพัะธะธ ะพะฟะตัะฐัะธะน
6. **Graceful shutdown** โ ะบะพััะตะบัะฝะพะต ะทะฐะฒะตััะตะฝะธะต ะฟัะธ ะพััะฐะฝะพะฒะบะต

## Troubleshooting

### ะัะธะฑะบะฐ "API credentials required"
ะัะพะฒะตัััะต ััะพ ะฒ .env ะทะฐะดะฐะฝั CLOB_API_KEY, CLOB_SECRET, CLOB_PASS_PHRASE

### ะัะดะตัะฐ ะฝะต ัะพะทะดะฐัััั
1. ะัะพะฒะตัััะต ะฑะฐะปะฐะฝั USDC ะฝะฐ Polymarket
2. ะัะพะฒะตัััะต ััะพ funder address ะบะพััะตะบัะฝัะน
3. ะัะพะฒะตัััะต ะปะพะณะธ ะฝะฐ ะพัะธะฑะบะธ ะพั CLOB API

### ะะพั ะฝะต ะฒะธะดะธั ะฝะพะฒัะต ะผะฐัะบะตัั
1. ะัะพะฒะตัััะต ะฟะพะดะบะปััะตะฝะธะต ะบ RTDS (ะดะพะปะถะตะฝ ะฑััั ะปะพะณ "Connected")
2. ะฃะฑะตะดะธัะตัั ััะพ ะฟะพะดะฟะธัะบะฐ ะฐะบัะธะฒะฝะฐ ("Subscribed to market_created")
3. BTC updown ะผะฐัะบะตัั ัะพะทะดะฐัััั ะบะฐะถะดัะต 15 ะผะธะฝัั

## ะขะตััะธัะพะฒะฐะฝะธะต Latency

### src/test-latency.ts

ะกะบัะธะฟั ะดะปั ะธะทะผะตัะตะฝะธั latency HTTP POST ะทะฐะฟัะพัะพะฒ ะบ Polymarket CLOB API.

**ะะพะณะธะบะฐ ัะฐะฑะพัั:**
1. Polling Gamma API ะดะพ ะฟะพัะฒะปะตะฝะธั ะผะฐัะบะตัะฐ
2. ะะดัั DELAY_BEFORE_SPAM_MS (19 ัะตะบ)
3. Pre-sign 1 ะพัะดะตั (UP @ 0.45, expiration = 1 ัะตะบ ะดะพ ััะฐััะฐ)
4. Spam postSignedOrder() ั 20 ะฟะฐัะฐะปะปะตะปัะฝัะผะธ ะทะฐะฟัะพัะฐะผะธ
5. ะะพะณะธััะตั ะบะฐะถะดัะน ะทะฐะฟัะพั ะฒ CSV ัะฐะนะป
6. ะัะฒะพะดะธั ััะฐัะธััะธะบั: min, max, avg, median

**ะะฐะฟััะบ:**
```bash
npm run test-latency btc-updown-15m-1764930600
```

**CSV ัะฐะนะป:** `latency.csv`
```csv
timestamp,slug,side,price,latency_ms,success,error
```

**ะขะธะฟะธัะฝัะต ะทะฝะฐัะตะฝะธั latency:**
- ะกะจะ (ะฑะปะธะทะบะพ ะบ ัะตัะฒะตัะฐะผ): ~250-300ms
- ะะฒัะพะฟะฐ: ~400-500ms
- ะะทะธั/ะดะฐะปะตะบะพ: ~600-800ms

**ะะปะธัะฝะธะต ะฝะฐ ะฑะพัะฐ:**
- Latency ะพะฟัะตะดะตะปัะตั ัะบะพะปัะบะพ ะฟะพะฟััะพะบ ะฑะพั ััะฟะตะตั ัะดะตะปะฐัั
- ะัะธ 285ms ะทะฐ 6 ัะตะบ = ~420 ะฟะพะฟััะพะบ
- ะัะธ 600ms ะทะฐ 6 ัะตะบ = ~200 ะฟะพะฟััะพะบ (ะฒ 2 ัะฐะทะฐ ะผะตะฝััะต!)

### ะะพะผะฟะพะฝะตะฝัั latency

```
HTTP POST /order:
โโ DNS ัะตะทะพะปะฒ:           ~1ms   (ะบััะธััะตััั)
โโ TCP/TLS handshake:    ~10ms  (keep-alive)
โโ ะกะะะะะ ะะะะะะะขะะ:   ~250ms   โ ะณะปะฐะฒะฝัะน bottleneck
โ   โโ ะะฐะปะธะดะฐัะธั ะฟะพะดะฟะธัะธ
โ   โโ ะัะพะฒะตัะบะฐ ะฑะฐะปะฐะฝัะฐ
โ   โโ Matching engine
โ   โโ ะะฐะฟะธัั ะฒ ะะ
โโ ะัะฒะตั ัะตัะฒะตัะฐ:       ~20ms
```

## C++ Latency Test

### ะกัะฐััั: โ Raw HTTP ัะฐะฑะพัะฐะตั

C++ ะฒะตััะธั latency ัะตััะฐ ะดะปั ััะฐะฒะฝะตะฝะธั ั TypeScript.
ะฆะตะปั: ะฟัะพะฒะตัะธัั, ะดะฐัั ะปะธ C++ ะฝะฐ libcurl ะฒัะธะณััั ะฒ latency.

### ะคะฐะนะปั
- `src/cpp/test-latency.cpp` โ C++ HTTP ัะฟะฐะผ ั libcurl + OpenSSL HMAC
- `src/test-latency-cpp.ts` โ Node.js ะพะฑัััะบะฐ (polling + pre-sign)
- `build-cpp.sh` โ ัะบัะธะฟั ะบะพะผะฟะธะปััะธะธ ะดะปั Ubuntu

### ะะฐะฟััะบ
```bash
npm run build:cpp  # ะบะพะผะฟะธะปััะธั C++
npm run test-latency-cpp btc-updown-15m-TIMESTAMP
```

### ะะตััะฝะฝัะต ะฟัะพะฑะปะตะผั

#### 1. 401 Unauthorized
- **POLY_ADDRESS**: ะัะถะตะฝ wallet address, ะฝะต funder address
- **Header names**: `POLY_ADDRESS` (underscore), ะฝะต `POLY-ADDRESS` (hyphen)
- **Signature**: URL-safe base64 (`+`โ`-`, `/`โ`_`)

#### 2. 400 "Invalid order payload"
SDK ะบะพะฝะฒะตััะธััะตั ัะธะฟั ะฒ `orderToJson()`:
- `side: 0` โ `side: "BUY"` (ัััะพะบะฐ, ะฝะต ัะธัะปะพ!)
- `orderType: 1` โ `orderType: "GTD"` (ัััะพะบะฐ, ะฝะต ัะธัะปะพ!)

**ะัะฟัะฐะฒะปะตะฝะธะต:**
```typescript
const transformedOrder = {
  ...signedOrder,
  salt: parseInt(signedOrder.salt, 10),
  side: signedOrder.side === 0 ? 'BUY' : 'SELL',  // KEY FIX
};

const orderBody = JSON.stringify([{
  deferExec: false,
  order: transformedOrder,
  owner: tradingConfig.apiKey,
  orderType: 'GTD',  // String, not number!
}]);
```

### ะะพะผะฐะฝะดั
```bash
# ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน (Ubuntu)
sudo apt-get install -y build-essential libcurl4-openssl-dev libssl-dev

# ะะพะผะฟะธะปััะธั
npm run build:cpp

# ะะฐะฟััะบ
npm run test-latency-cpp btc-updown-15m-<TIMESTAMP>
```

## ะะธะทัะฐะปะธะทะฐัะธั Latency (Python)

### ะคะฐะนะป: `scripts/plot_latency.py`

ะกะบัะธะฟั ะดะปั ะฟะพัััะพะตะฝะธั ะณัะฐัะธะบะพะฒ latency ะฝะฐ ะพัะฝะพะฒะต `latency.csv`.

**ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน:**
```bash
pip install pandas matplotlib
```

**ะะฐะฟััะบ:**
```bash
python scripts/plot_latency.py latency.csv
```

**ะคัะฝะบัะธะธ:**
- ะะฐะณััะถะฐะตั CSV ั ัะตะทัะปััะฐัะฐะผะธ latency ัะตััะพะฒ
- ะกััะพะธั ะณัะฐัะธะบ latency ะฒะพ ะฒัะตะผะตะฝะธ ั ัะพัะฝัะผะธ ะทะฝะฐัะตะฝะธัะผะธ (ะผั) ะฝะฐะด ะบะฐะถะดะพะน ัะพัะบะพะน
- ะะพะบะฐะทัะฒะฐะตั ะฒัะตะผั ะฒ ัะพัะผะฐัะต HH:MM:SS.mmm ะฝะฐ ะพัะธ X
- ะกััะพะธั ะณะธััะพะณัะฐะผะผั ัะฐัะฟัะตะดะตะปะตะฝะธั latency
- ะัะฒะพะดะธั ััะฐัะธััะธะบั: min, max, mean, median, std, P95, P99
- ะกะพััะฐะฝัะตั PNG ัะฐะนะป
- ะขัะผะฝะฐั ัะตะผะฐ

**ะััะพะดะฝัะต ัะฐะนะปั:**
- `latency_plot.png` โ ะณัะฐัะธะบะธ latency

## Redemption Bot - ะะฒัะพะผะฐัะธัะตัะบะธะน ะฒัะบัะฟ ะฟะพะทะธัะธะน

### ะะฑะทะพั

**Redemption Bot** โ ะฐะฒัะพะผะฐัะธัะตัะบะธะน Python ะฑะพั ะดะปั ะฒัะบัะฟะฐ ะทะฐะฒะตััะตะฝะฝัั ะฟะพะทะธัะธะน ะฝะฐ Polymarket. ะะฐะฟััะบะฐะตััั ะบะฐะถะดัะต 60 ะผะธะฝัั ัะตัะตะท systemd timer ะธ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฒัะบัะฟะฐะตั (redeem) ะฟะพะทะธัะธะธ ั ะทะฐะฒะตััะตะฝะฝัั ะผะฐัะบะตัะพะฒ.

### ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Systemd Timer (ะบะฐะถะดัะต 60 ะผะธะฝัั)                           โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Python Redemption Bot (main.py)                           โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ  โ 1. config.py โ Load .env credentials              โ     โ
โ  โโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ                  โผ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ  โ 2. polymarket_api.py โ GET /balances/{funder}     โ     โ
โ  โโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ                  โผ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ  โ 3. redemption_logic.py โ Group by condition_id    โ     โ
โ  โ    Calculate indexSets for each outcome           โ     โ
โ  โโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ                  โผ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ  โ 4. relayer_client.py โ POST /redeem               โ     โ
โ  โ    Builder Relayer integration                    โ     โ
โ  โโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ                  โผ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ  โ 5. telegram_notifier.py โ Send to Telegram        โ     โ
โ  โ    csv_logger.py โ Log to redemption.csv          โ     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะคะฐะนะปั

```
scripts/
โโโ redemption/
โ   โโโ __init__.py              # Python package marker
โ   โโโ main.py                  # Entry point (systemd ะทะฐะฟััะบะฐะตั ััะพ)
โ   โโโ config.py                # ะะฐะณััะทะบะฐ .env, ะฒะฐะปะธะดะฐัะธั
โ   โโโ polymarket_api.py        # GET /balances API client
โ   โโโ redemption_logic.py      # ะััะฟะฟะธัะพะฒะบะฐ ะฟะพ condition_id, indexSets
โ   โโโ relayer_client.py        # Builder Relayer + HMAC auth
โ   โโโ telegram_notifier.py     # Telegram ัะฒะตะดะพะผะปะตะฝะธั (HTTP)
โ   โโโ csv_logger.py            # CSV ะปะพะณะธ
โโโ requirements.txt             # Python ะทะฐะฒะธัะธะผะพััะธ

systemd/
โโโ redemption-bot.service       # Systemd service (oneshot)
โโโ redemption-bot.timer         # Systemd timer (60 min)

logs/
โโโ redemption.csv               # CSV ะปะพะณ ัะตะทัะปััะฐัะพะฒ
```

### ะะพะณะธะบะฐ ัะฐะฑะพัั

1. **Systemd timer** ะทะฐะฟััะบะฐะตั `main.py` ะบะฐะถะดัะต 60 ะผะธะฝัั
2. **API ะทะฐะฟัะพั**: GET `/balances/{funder_address}` โ ะฟะพะปััะธัั ะฟะพะทะธัะธะธ
3. **ะััะฟะฟะธัะพะฒะบะฐ**: ะฟะพ `condition_id`, ะฒััะธัะปะตะฝะธะต `indexSets` (2^outcome_index)
4. **Redemption**: POST `/redeem` ัะตัะตะท Builder Relayer (ะณะฐะท ะฟะพะบััะฒะฐะตั relayer)
5. **ะฃะฒะตะดะพะผะปะตะฝะธั**: Telegram (ะฝะฐัะฐะปะพ, ะฝะฐะนะดะตะฝั ะฟะพะทะธัะธะธ, ััะฟะตั/ะพัะธะฑะบะฐ)
6. **ะะพะณะธัะพะฒะฐะฝะธะต**: CSV ัะฐะนะป (timestamp, condition, amount, tx_hash, status)

### ะฃััะฐะฝะพะฒะบะฐ

```bash
# 1. ะฃััะฐะฝะพะฒะธัั Python ะทะฐะฒะธัะธะผะพััะธ
pip3 install -r scripts/requirements.txt

# 2. ะขะตัั (manual run)
python3 scripts/redemption/main.py

# 3. ะฃััะฐะฝะพะฒะธัั systemd timer (Linux VPS)
sudo cp systemd/redemption-bot.* /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable redemption-bot.timer
sudo systemctl start redemption-bot.timer

# 4. ะัะพะฒะตัะธัั ััะฐััั
sudo systemctl status redemption-bot.timer
sudo journalctl -u redemption-bot.service -f
```

### ะะพะฝะธัะพัะธะฝะณ

```bash
# ะกัะฐััั timer
sudo systemctl list-timers redemption-bot.timer

# Live logs (systemd journal)
sudo journalctl -u redemption-bot.service -f

# CSV ัะตะทัะปััะฐัั
tail -f logs/redemption.csv

# ะััะฝะพะน ะทะฐะฟััะบ (ะฝะต ะดะพะถะธะดะฐัััั timer)
sudo systemctl start redemption-bot.service
```

### Telegram ัะฒะตะดะพะผะปะตะฝะธั

ะัะปะธ ะฝะฐัััะพะตะฝั `TELEGRAM_BOT_TOKEN` ะธ `TELEGRAM_ADMIN_ID`, ะฑะพั ะพัะฟัะฐะฒะปัะตั:

- ๐ **Check start**: "Redemption Check Started" (ะฒัะตะผั ะทะฐะฟััะบะฐ)
- ๐ฐ **Found positions**: "Found 3 conditions, $45.67 USDC to redeem"
- โ **Success**: "Redeemed $15.00 from condition abc123... (tx: 0xdef456...)"
- โ **Error**: "Failed to redeem condition xyz789...: error message"
- โน๏ธ **No positions**: "No positions to redeem"

### CSV ัะพัะผะฐั

`logs/redemption.csv`:

```csv
timestamp,condition_id,parent_collection_id,index_sets,amount_usdc,status,tx_hash,error
2025-12-14T10:00:15,0xabc123...,0x000...,1|2,15.500000,success,0xdef456...,
2025-12-14T10:00:18,0xghi789...,0x000...,1,8.250000,error,,Relayer timeout
```

### IndexSets Calculation

Binary markets (2 outcomes):
- Outcome 0 (YES) โ indexSet = 2^0 = 1 (binary: 01)
- Outcome 1 (NO) โ indexSet = 2^1 = 2 (binary: 10)

Multi-outcome markets:
- indexSet = 1 << outcome_index (bitshift)

### Builder Relayer Integration

ะัะฟะพะปัะทัะตั ัะต ะถะต credentials ััะพ CLOB API (`CLOB_API_KEY`, `CLOB_SECRET`, `CLOB_PASS_PHRASE`):

1. **HMAC-SHA256 signature**: `timestamp + method + path + body`
2. **Headers**:
   - `POLY_ADDRESS`: wallet address (ะะ funder!)
   - `POLY_SIGNATURE`: URL-safe base64
   - `POLY_TIMESTAMP`: unix timestamp
   - `POLY_API_KEY`: API key
   - `POLY_PASSPHRASE`: passphrase

3. **Endpoint**: POST `/redeem`
   - `conditionId`: condition ID ะผะฐัะบะตัะฐ
   - `indexSets`: ัะฟะธัะพะบ indexSets ะดะปั ะฒัะบัะฟะฐ
   - `parentCollectionId`: ะพะฑััะฝะพ 0x000...

### ะะพะฝัะธะณััะฐัะธั

ะัะฟะพะปัะทัะตั ัััะตััะฒัััะธะต credentials ะธะท `.env`:
- `PK` โ ะฟัะธะฒะฐัะฝัะน ะบะปัั (ะดะปั ะฟะพะดะฟะธัะธ)
- `FUNDER` โ funder address (ะดะปั API ะทะฐะฟัะพัะพะฒ)
- `CLOB_API_KEY`, `CLOB_SECRET`, `CLOB_PASS_PHRASE` โ Builder Relayer auth
- `TELEGRAM_BOT_TOKEN`, `TELEGRAM_ADMIN_ID` โ ัะฒะตะดะพะผะปะตะฝะธั (ะพะฟัะธะพะฝะฐะปัะฝะพ)

### Systemd Timer

**redemption-bot.timer**:
- `OnBootSec=5min` โ ะฟะตัะฒัะน ะทะฐะฟััะบ ัะตัะตะท 5 ะผะธะฝ ะฟะพัะปะต ะทะฐะณััะทะบะธ
- `OnUnitActiveSec=60min` โ ะฟะพะฒัะพัะฝัะน ะทะฐะฟััะบ ะบะฐะถะดัะต 60 ะผะธะฝัั
- `Persistent=true` โ ะทะฐะฟััะบะฐัั ะฟัะพะฟััะตะฝะฝัะต runs (ะตัะปะธ ัะธััะตะผะฐ ะฑัะปะฐ ะฒัะบะปััะตะฝะฐ)
- `RandomizedDelaySec=5min` โ ัะปััะฐะนะฝะฐั ะทะฐะดะตัะถะบะฐ ะดะพ 5 ะผะธะฝ (ะธะทะฑะตะถะฐัั ะฝะฐะณััะทะบะธ ัะพะฒะฝะพ ะฒ ัะฐั)

**redemption-bot.service**:
- `Type=oneshot` โ ะทะฐะฟััะบะฐะตััั ะพะดะธะฝ ัะฐะท, ะทะฐะฒะตััะฐะตััั
- `Restart=on-failure` โ restart ะตัะปะธ exit code != 0 (ะฟะพัะปะต 5 ะผะธะฝ)
- `StandardOutput=journal` โ ะปะพะณะธ ะฒ systemd journalctl

### ะะพะบัะผะตะฝัะฐัะธั

ะะพะดัะพะฑะฝะฐั ะธะฝััััะบัะธั ะฒ `REDEMPTION_README.md`:
- ะฃััะฐะฝะพะฒะบะฐ ะธ ะฝะฐัััะพะนะบะฐ
- ะะพะผะฐะฝะดั ัะฟัะฐะฒะปะตะฝะธั
- ะะพะฝะธัะพัะธะฝะณ ะธ troubleshooting
- ะะทะผะตะฝะตะฝะธะต ะธะฝัะตัะฒะฐะปะฐ
- ะะฝัะตะณัะฐัะธั ั Telegram ะฑะพัะพะผ

## Troubleshooting (ะะฐััะธัะตะฝะฝัะน)

### C++ Latency Test: latencyRecords.length = 0

**ะัะพะฑะปะตะผะฐ:** ะ ะปะพะณะฐั `[TRACK] latencyRecords.length = 0` ะดะฐะถะต ะฟะพัะปะต ะฒัะทะพะฒะฐ `trackLatency()`.

**ะัะธัะธะฝะฐ:** ะคัะฝะบัะธั `shouldLog()` ะฒะพะทะฒัะฐัะฐะปะฐ `false` ะดะปั ะพัะธะฑะพะบ ั ัะพะพะฑัะตะฝะธะตะผ "the orderbook ... does not exist" โ ะฟัะพะฒะตัะบะฐ `error?.includes('does not exist')` ะฝะต ััะฐะฑะฐััะฒะฐะปะฐ ะธะท-ะทะฐ ะดััะณะพะณะพ ัะพัะผะฐัะฐ ัะพะพะฑัะตะฝะธั.

**ะะตัะตะฝะธะต:** ะะทะผะตะฝะธัั `shouldLog()` ััะพะฑั ะปะพะณะธัะพะฒะฐัั ะฒัะต ะฟะพะฟััะบะธ:
```typescript
function shouldLog(success: boolean, error?: string): boolean {
  if (success) return true;
  if (error?.includes('does not exist')) return true;
  return true;  // Log all attempts
}
```

### C++ stdout ะฝะต ะดะพัะพะดะธั ะดะพ Node.js

**ะัะพะฑะปะตะผะฐ:** ATTEMPT: ัััะพะบะธ ะธะท C++ ะฝะต ะฟะพัะฒะปัะปะธัั ะฒ Node.js.

**ะัะธัะธะฝะฐ:** C++ stdout ะฑััะตัะธะทัะตััั, ะดะฐะฝะฝัะต ะฝะต ัะฑัะฐััะฒะฐัััั ััะฐะทั.

**ะะตัะตะฝะธะต:** ะะพะฑะฐะฒะธัั `std::cout.flush()` ะฟะพัะปะต ะบะฐะถะดะพะณะพ ะฒัะฒะพะดะฐ ะฒ C++:
```cpp
std::cout << "ATTEMPT:" << attempts << ":" << latencyMs << ":true:" << orderId << std::endl;
std::cout.flush();
```

### ะัะดะตั ะฝะต ะพัะพะฑัะฐะถะฐะตััั ะฝะฐ Polymarket

**ะัะพะฑะปะตะผะฐ:** ะะพะณ ะฟะพะบะฐะทัะฒะฐะตั ััะฟะตั (status 200), ะฝะพ ะพัะดะตั ะฝะต ะฒะธะดะตะฝ.

**ะัะธัะธะฝะฐ:** Expiration ะฑัะป ะฒ ะฟัะพัะปะพะผ ะพัะฝะพัะธัะตะปัะฝะพ ะฒัะตะผะตะฝะธ ะพัะฟัะฐะฒะบะธ. ะัะดะตั ะผะณะฝะพะฒะตะฝะฝะพ ะธััะตะบะฐะป.

**ะะตัะตะฝะธะต:** ะัะฟะพะปัะทะพะฒะฐัั `expirationBuffer` ะธะท `ORDER_CONFIG` ะฒะผะตััะพ ะทะฐัะฐัะดะบะพะถะตะฝะฝะพะณะพ ะทะฝะฐัะตะฝะธั:
```typescript
const expirationTimestamp = marketTimestamp - TEST_EXPIRATION_BUFFER;
```

### Status 200 ะฝะพ orderID ะฟัััะพะน

**ะัะพะฑะปะตะผะฐ:** HTTP 200 OK, ะฝะพ ะฒ ะพัะฒะตัะต `orderID: ""` ะธ ะพัะดะตั ะฝะต ะฟะพััะฐะฒะปะตะฝ.

**ะัะธัะธะฝะฐ:** ะะพะด ะฟัะพะฒะตััะป ัะพะปัะบะพ `status === 200`, ะฝะพ ะฝะต ะฟัะพะฒะตััะป ััะพ `orderID` ะฝะต ะฟัััะพะน. ะกะตัะฒะตั ะฒะพะทะฒัะฐัะฐะตั 200 ะดะฐะถะต ะบะพะณะดะฐ orderbook ะฝะต ัััะตััะฒัะตั.

**ะะตัะตะฝะธะต:** ะะพะฑะฐะฒะธัั ะฟัะพะฒะตัะบั `orderID`:
```typescript
if (rawResp.status === 200) {
  const parsed = JSON.parse(rawResult);
  const orderId = parsed[0]?.orderID || '';
  if (orderId) {
    // ะฃัะฟะตั - ะพัะดะตั ัะตะฐะปัะฝะพ ะฟะพััะฐะฒะปะตะฝ
  } else {
    // Orderbook ะฝะต ัััะตััะฒัะตั
  }
}
```

### CSV: ัะฐะทะฝะพะต ะบะพะปะธัะตััะฒะพ ะบะพะปะพะฝะพะบ

**ะัะพะฑะปะตะผะฐ:** pandas ะฝะต ะผะพะถะตั ะฟัะพัะธัะฐัั CSV ั ัะฐะทะฝัะผ ะบะพะปะธัะตััะฒะพะผ ะบะพะปะพะฝะพะบ (ััะฐััะน ัะพัะผะฐั 12, ะฝะพะฒัะน 19).

**ะะตัะตะฝะธะต:** ะงะธัะฐัั ะฟะพ ะฟะพะทะธัะธะธ ะบะพะปะพะฝะพะบ:
```python
df = pd.read_csv(csv_path, header=None, skiprows=1,
                 usecols=[0, 7, 8],
                 names=['server_time_ms', 'latency_ms', 'status'])
```

### Stream spam: ะฝะต ะฒัะต ะพัะดะตัะฐ ััะฐะฒัััั

**ะัะพะฑะปะตะผะฐ:** ะัะธ stream ัะฟะฐะผะต ััะฐะฒัััั ัะพะปัะบะพ 6-9 ะพัะดะตัะพะฒ ะธะท 10, ัะปััะฐะนะฝัะต ะพัะดะตัะฐ ะฟัะพะฟััะบะฐัััั.

**ะัะธัะธะฝะฐ:** `sendRequest()` ะฝะต ะถะดัั ะพัะฒะตัะฐ โ ะทะฐะฟัะพัั "ะฒ ะฟะพะปััะต" ะบะพะณะดะฐ ัะธะบะป ัะถะต ะทะฐะฒะตััะฐะตััั. ะะตะบะพัะพััะต ะพัะฒะตัั ะฟัะธัะพะดัั ะฟะพัะปะต ะฒััะพะดะฐ ะธะท ัะธะบะปะฐ.

**ะะตัะตะฝะธะต:** ะกะพััะฐะฝััั ะฒัะต ะฟัะพะผะธัั ะธ ะถะดะฐัั ะธั ะฒ ะบะพะฝัะต:
```typescript
const inFlightRequests: Promise<void>[] = [];

const sendRequest = (order) => {
  const promise = tradingService.postSignedOrder(...)
    .then(result => { order.placed = true; })
    .catch(() => {});
  inFlightRequests.push(promise);  // ะกะพััะฐะฝัะตะผ ะฟัะพะผะธั
};

// ะะพัะปะต ัะธะบะปะฐ - ะถะดัะผ ะฒัะต ะทะฐะฟัะพัั
await Promise.all(inFlightRequests);
```

### Polymarket ะดะพะฑะฐะฒะปัะตั +60 ัะตะบ ะบ expiration

**ะัะพะฑะปะตะผะฐ:** ะัะดะตั ะทะฐะบััะฒะฐะตััั ะทะฐ 90 ัะตะบ ะดะพ ััะฐััะฐ ะฒะผะตััะพ ะพะถะธะดะฐะตะผัั 30 ัะตะบ.

**ะัะธัะธะฝะฐ:** Polymarket ะฐะฒัะพะผะฐัะธัะตัะบะธ ะดะพะฑะฐะฒะปัะตั +60 ัะตะบัะฝะด ะบ ะทะฝะฐัะตะฝะธั expiration ะฟัะธ ัะพะทะดะฐะฝะธะธ GTD ะพัะดะตัะฐ.

**ะะตัะตะฝะธะต:** ะััะธัะฐัั 60 ะธะท ะถะตะปะฐะตะผะพะณะพ ะทะฝะฐัะตะฝะธั expirationBuffer:
```typescript
// ะฅะพัะธะผ: 30 ัะตะบ ะดะพ ััะฐััะฐ
// PM ะดะพะฑะฐะฒะธั +60, ะฟะพะปััะธััั: 30+60 = 90 ัะตะบ ะดะพ ััะฐััะฐ
// ะะพััะพะผั ััะฐะฒะธะผ: 30-60 = -30
{ price: 0.45, size: 10, expirationBuffer: -30 },  // 30 ัะตะบ ะดะพ ััะฐััะฐ
```

**ะคะพัะผัะปะฐ:** `expirationBuffer = ะถะตะปะฐะตะผะพะต_ะฒัะตะผั_ะดะพ_ััะฐััะฐ - 60`

## ะััะพัะธั

- **2025-12-14**: Redemption Bot - ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะฒัะบัะฟ ะฟะพะทะธัะธะน (Python, systemd timer, Telegram ัะฒะตะดะพะผะปะตะฝะธั)
- **2025-12-09**: Fix expirationBuffer - ัััั +60 ัะตะบ ะพั Polymarket
- **2025-12-08**: Python ะฒะธะทัะฐะปะธะทะฐัะธั latency (plot_latency.py), ััะผะฝะฐั ัะตะผะฐ, ะฟะพะดะฟะธัะธ ะทะฝะฐัะตะฝะธะน
- **2025-12-08**: Fix latencyRecords tracking - shouldLog() ัะตะฟะตัั ะปะพะณะธััะตั ะฒัะต ะฟะพะฟััะบะธ
- **2025-12-08**: Fix C++ stdout buffering - ะดะพะฑะฐะฒะปะตะฝ flush()
- **2025-12-08**: Fix expiration - ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ORDER_CONFIG.expirationBuffer
- **2025-12-05**: C++ latency test โ Auth ัะฐะฑะพัะฐะตั! (fix: wallet addr, underscore headers, URL-safe base64)
- **2025-12-04**: ะะพะฑะฐะฒะปะตะฝ test-latency.ts ะดะปั ะธะทะผะตัะตะฝะธั latency
- **2025-12-03**: 10 ะพัะดะตัะพะฒ ั ะธะฝะดะธะฒะธะดัะฐะปัะฝัะผะธ expiration times
- **2025-11-25**: ะกะพะทะดะฐะฝ ะฟัะพะตะบั, ะฒัะดะตะปะตะฝ ะธะท live-trade-PM
- ะะตะฟะพะทะธัะพัะธะน: https://github.com/Bezoutoff/Tuda_Suda_49
